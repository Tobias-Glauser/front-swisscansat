<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flight</title>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-base.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            font-family: 'Barlow', serif;
        }

        body {
            max-width: 800px;
            margin: auto;
        }

        h1 {
            font-size: 3em;
            margin: .5rem 0;
        }

        h2.flight-date {
            color: #c1bfbf;
            font-size: 2em;
            margin: .5rem 0;
        }

        #container {
            height: 500px;
        }

        .data-bloc {
            border: 1px solid rgba(0, 0, 0, 0.2);
            margin: 0.5em;
            padding: 1.3em;
            border-radius: 16px;
        }

        .data-bloc > div {
            color: #477A8B;
            text-align: center;
            font-size: 2rem;
            width: 4em;
        }

        .data-bloc > div:first-child {
            color: #000000;
        }

        .data-bloc > div.long-texte {
            font-size: 1.5rem;
            text-align: center;
            width: 100%;
        }

        .live-data {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        body {
            font-family: 'Barlow', serif;
        }

        .flight-status {
            color: #477A8BFF;
        }

        #flight-container a {
            display: block;
            justify-content: space-between;
            border: solid black 1px;
            border-radius: 25px;
            padding: 1em;
            margin: 1em;
        }

        #rejouer {
            text-align: center;
            display: none;
        }

        #rejouer button {
            background-color: #477A8B;
            color: #FFFFFF;
            font-size: 1em;
            border-radius: 50px;
            border: none;
            padding: 1rem;
        }

        #rejouer h2 {
            margin: 15px;
        }
    </style>

</head>
<body>

<section class="header">
    <h1 id="flight-name">Vol test 1</h1>
    <h2 class="flight-date">19.02.2023 14h00</h2>
</section>
<section class="altitude-chart">
    <h2>Altitude de la capsule</h2>
    <div id="container"></div>
</section>
<section id="rejouer">
    <h2>Simulation terminée : voulez vous rejouer ?</h2>
    <button>Rejouer</button>
</section>
<h2>Données en direct</h2>
<section class="live-data">

    <div class="data-bloc">
        <div>Altitude</div>
        <div id="altitude"></div>
    </div>
    <div class="data-bloc">
        <div>CO2</div>
        <div id="co2"></div>
    </div>
    <div class="data-bloc">
        <div>Humidité</div>
        <div id="humidity"></div>
    </div>
    <div class="data-bloc">
        <div>Temp.</div>
        <div id="temperature"></div>
    </div>
    <div class="data-bloc">
        <div>Pression</div>
        <div class="long-texte" id="pressure"></div>
    </div>
    <div class="data-bloc">
        <div>GPS</div>
        <div class="long-texte" id="gpsN">41°24'12.2"N</div>
        <div class="long-texte" id="gpsE">2°10'26.5"E</div>
    </div>
</section>


<script>

    let flightData = [];
    let replayData = [];
    const flightContainer = document.getElementById("flight-container");
    const flightId = sessionStorage.getItem('flight-id');
    const flightName = document.getElementById("flight-name");
    const flightDate = document.querySelector('.flight-date')
    const container = document.getElementById('container');
    const rejouerContainer = document.getElementById('rejouer')
    const rejouerButton = document.querySelector("#rejouer button");
    const apiURL = 'https://env-7485037.jcloud.ik-server.com/api/v1/'
    // const apiURL = 'http://127.0.0.1:8080/api/v1/'
    let newData = [];
    let flight;

    const wait = async (ms) => {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }

    class FlightData {
        id;
        flight;
        timestamp;
        altitude;
        co2Measure;
        tempMeasure;
        gps;
        humidityMeasure;
        airPressureMeasure;

        constructor(flightData) {
            this.id = flightData.id;
            this.flight = new Flight(flightData.flight);
            this.timestamp = new Date(flightData.timestamp);
            this.altitude = flightData.altitude;
            this.co2Measure = flightData.co2Measure;
            this.tempMeasure = flightData.tempMeasure;
            this.gps = flightData.gps;
            this.humidityMeasure = flightData.humidityMeasure;
            this.airPressureMeasure = flightData.airPressureMeasure;
            console.log(flightData.airPressureMeasure, this.airPressureMeasure)
        }
    }

    class ReplayFlightData extends FlightData {
        delay;

        constructor(flightDataObject, previousTimestamp) {
            super(flightDataObject);
            this.delay = flightDataObject.timestamp - previousTimestamp;
        }
    }

    class FlightDataSearchQuery {
        timestamp;
        flightId;
        page;
        size;

        constructor(timestamp, flightId, page, size) {
            this.timestamp = timestamp;
            this.flightId = flightId;
            this.page = page;
            this.size = size;
        }

    }

    class SearchResult {
        page;
        pageSize;
        totalElements;
        totalPages;
        content;

        constructor(searchResult) {
            this.page = searchResult.page;
            this.pageSize = searchResult.pageSize;
            this.totalElements = searchResult.totalElements;
            this.totalPages = searchResult.totalPages;
            this.content = searchResult.content;
        }
    }

    class FlightStatus {
        id = null;
        statusName = "";

        constructor(status) {
            this.id = status.id;
            this.statusName = status.statusName;
        }
    }

    class Flight {
        id = null;
        status = null;
        flightName = "";
        flightDateTime = null;

        constructor(flight) {
            this.id = flight.id;
            this.status = new FlightStatus(flight.status);
            this.flightName = flight.flightName;
            this.flightDateTime = flight.flightDateTime;
        }

    }

    async function getFlight() {
        return new Promise(async callback => {
            // Create a request variable and assign a new XMLHttpRequest object to it.
            let request = new XMLHttpRequest()

            // Open a new connection, using the GET request on the URL endpoint
            request.open('GET', apiURL + 'flight/' + flightId, true)
            request.setRequestHeader('Access-Control-Allow-Origin', '*');
            request.setRequestHeader('Content-type', 'application/json');
            request.setRequestHeader('Sec-Fetch-Mode', 'cors');

            request.onload = function () {
                let data = JSON.parse(request.responseText);

                callback(new Flight(data))
            }


// Send request
            request.send()

        })
    }

    async function getLowestAltitude() {
        return new Promise( callback => {
            // Create a request variable and assign a new XMLHttpRequest object to it.
            let request = new XMLHttpRequest()

            // Open a new connection, using the GET request on the URL endpoint
            request.open('GET', apiURL + 'flightdata/lowest-altitude?flightId=' + flightId, true)
            request.setRequestHeader('Access-Control-Allow-Origin', '*');
            request.setRequestHeader('Content-type', 'application/json');
            request.setRequestHeader('Sec-Fetch-Mode', 'no-cors');

            request.onload = async function () {
                callback(JSON.parse(request.responseText));
            }

            request.send()
        })
    }

    function createReplayData() {
        let previousTimestamp = flightData[0].timestamp;
        flightData.forEach((data) => {
            replayData.push(new ReplayFlightData(data, previousTimestamp));
            previousTimestamp = data.timestamp;
            console.log(replayData);
        })
    }

    async function getAllData() {
        return new Promise(async callback => {
            // let lastTimestamp = new Date(0o000, 0o0, 0o000, 0o0, 0o0);
            // let lastTimestamp = new Date(2023, 1, 3, 12, 45);
            let lastTimestamp = new Date(2023, 1, 16, 10, 58);

            let searchQuery = new FlightDataSearchQuery(lastTimestamp, flightId, 0, 1000)
            await executeGetFlightData(searchQuery);
            console.log("Finsihed get all data")
            callback();
        })
    }

    async function executeGetFlightData(searchQuery) {
        return new Promise(
            callback => {
                let request = new XMLHttpRequest()
                console.log(searchQuery.timestamp)
                console.log(searchQuery.timestamp.toUTCString())
                console.log(searchQuery.timestamp.toISOString().replace('Z', ''))

                let ISODate = new Date(searchQuery.timestamp.getTime() - (searchQuery.timestamp.getTimezoneOffset() * 60000)).toISOString();
                // Open a new connection, using the GET request on the URL endpoint
                request.open('GET', apiURL + 'flightdata?flightId=' + searchQuery.flightId + '&page=' + searchQuery.page + '&size=' + searchQuery.size + '&timestamp=' + ISODate.replace('Z', ''), true)
                request.setRequestHeader('Access-Control-Allow-Origin', '*');
                request.setRequestHeader('Content-type', 'application/json');
                // request.setRequestHeader('Sec-Fetch-Mode','no-cors');
                // request.setRequestHeader('Authorization', 'Basic ' + btoa('Admin:admin'))

                let searchResult;

                request.onload = async function () {
                    let data = JSON.parse(request.responseText);
                    data.content.forEach(function (flight) {
                        flightData.push(new FlightData(flight))
                    })
                    console.log(data)
                    searchResult = new SearchResult(data)

                    if (searchResult.totalPages > searchResult.page + 1) {
                        console.log(searchResult.pageSize)
                        let searchQuery = new FlightDataSearchQuery(flightData.slice(-1)[0].timestamp, flightId, 0, searchResult.pageSize)
                        await executeGetFlightData(searchQuery)
                    } else {
                        console.log("finised")
                        console.log("--------------------")
                        createReplayData();
                    }
                    callback();

                }

                request.send();
            }
        )
    }

    //
    // getFlights();

    async function replayFlight() {
        for (let data of replayData) {
            updateFront(data);
            console.log("updated front")
            console.log(data.delay)
            await wait(data.delay)
        }
        rejouerContainer.style.display = 'block';
    }



    function updateFront(data) {
        addPoint(data)
        const divAltitude = document.getElementById('altitude');
        const divCo2 = document.getElementById('co2');
        const divHumidity = document.getElementById('humidity');
        const divTemperature = document.getElementById('temperature');
        const divPressure = document.getElementById('pressure');
        const divGpsN = document.getElementById('gpsN');
        const divGpsE = document.getElementById('gpsE');
        console.log("ici", data.altitude)
        divAltitude.innerText = data.altitude + " M";
        console.log(divAltitude.innerText)
        divCo2.innerText = data.co2Measure + " %";
        divHumidity.innerText = data.humidityMeasure + " %";
        divTemperature.innerText = data.tempMeasure + " °C";
        divPressure.innerText = data.airPressureMeasure + " hPa";
        const splitGPS = data.gps.split('-');
        divGpsN.innerText = 'N ' + splitGPS[0];
        divGpsE.innerText = 'E ' + splitGPS[1];
    }

    let chartData = []
    let dataSet = []
    let chart = anychart.line();

    async function createChart() {
        chart = anychart.line();

        // create a data set
        dataSet = anychart.data.set();

        // map the data for all series
        let firstSeriesData = dataSet.mapAs({x: 0, value: 1});

        // create the series and name them
        let firstSeries = chart.line(firstSeriesData);

        firstSeries.name("Atltitude");
        firstSeries.normal().fill("#477A8B");
        firstSeries.hovered().fill("#477A8B");
        firstSeries.selected().fill("#477A8B");
        firstSeries.normal().stroke("#477A8B");
        firstSeries.hovered().stroke("#477A8B");
        firstSeries.selected().stroke("#477A8B");

        chart.xAxis().title("temps [s]")
        chart.yAxis().title("Altitude [m]")

        chart.yScale().minimum(await getLowestAltitude());

        // specify where to display the chart
        chart.container("container");

        // chart.color = chart.color("Black")

        // draw the resulting chart
        chart.draw();
    }

    rejouerButton.addEventListener("click", (event) => {
        rejouerContainer.style.display = 'none';
        container.innerHTML = '';
        dataSet = []
        createChart();
        replayFlight();
    })

    function addPoint(data) {
        dataSet.append({x: data.timestamp.toLocaleTimeString() + '.' + data.timestamp.getMilliseconds(), value: data.altitude})
        console.log("updatedChart")
    }

    async function launchSimulation() {
        await getAllData();
        await replayFlight();
    }

    (async () => {
            flight = await getFlight();
            flightName.innerText = flight.flightName;
            flightDate.innerText = flight.flightDateTime;
        }
    )();
    createChart();
    launchSimulation()
</script>
</body>
</html>